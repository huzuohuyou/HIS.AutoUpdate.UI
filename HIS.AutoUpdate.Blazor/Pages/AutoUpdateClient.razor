@page "/AutoUpdateClient"
@using System.ComponentModel
@using AntDesign.TableModels
@using System.Text.Json;
@inject HttpClient Http
@using System.Text.Json.Serialization
<PageContainer Title="更新HIS客户端">
    <Card>
        <Button Type="primary" OnClick="@ConfigurationManager">/api/ConfigurationManager</Button>
        <Collapse DefaultActiveKey="@(new[] { "1" })"
                  OnChange="Callback"
                  ExpandIconPosition="@expandIconPosition"
                  ExpandIcon="caret-right">
            <Panel Header="HISModal.settingsSection.DWIO_HIS_DWIO_exe" Key="1" ExtraTemplate="@extra">
                <div>
                    <Input @bind-Value="@SYSTEM_HIS_Foundations_exe" />
                    <Button Type="primary">编辑</Button>
                    <Upload Action="https://www.mocky.io/v2/5cc8019d300000980a055e76"
                            Name="files"
                            OnSingleCompleted="OnSingleCompleted">
                        <Button Icon="upload">
                            <span>点击上传</span>
                        </Button>
                    </Upload>
                </div>
            </Panel>
        </Collapse>

    </Card>

</PageContainer>
@code
{
    public class ResponseModel
    {
        public string name { get; set; }

        public string status { get; set; }

        public string url { get; set; }

        public string thumbUrl { get; set; }
    }

    void OnSingleCompleted(UploadInfo fileinfo)
    {
        if (fileinfo.File.State == UploadState.Success)
        {
            var result = fileinfo.File.GetResponse<ResponseModel>();
            fileinfo.File.Url = result.url;
        }
    }

    class CurrentVersionURL
    {
        [JsonPropertyName("CurrentVersionURL")]
        public string currentVersionURL { get; set; }
        [JsonPropertyName("1.0.0.0")]
        public string _1_0_0_0 { get; set; }
    }
    class HISSettingsSection
    {
        #region HIS

        [JsonPropertyName("DWIO_HIS.DWIO.exe")]
        public CurrentVersionURL DWIO_HIS_DWIO_exe { get; set; } = new CurrentVersionURL { currentVersionURL = "123123" };
        [JsonPropertyName("IP_HIS.Inpatient.Pharmacy.exe")]
        public CurrentVersionURL IP_HIS_Inpatient_Pharmacy_exe { get; set; }
        [JsonPropertyName("OP_HIS.Outpatient.Pharmacy.exe")]
        public CurrentVersionURL OP_HIS_Outpatient_Pharmacy_exe { get; set; }
        [JsonPropertyName("MT_HIS.MT.exe")]
        public CurrentVersionURL MT_HIS_MT_exe { get; set; }
        [JsonPropertyName("HIS.Client.Launcher.exe")]
        public CurrentVersionURL HIS_Client_Launcher_exe { get; set; }
        [JsonPropertyName("OPD_HIS.Outpatient.RC.exe")]
        public CurrentVersionURL OPD_HIS_Outpatient_RC_exe { get; set; }
        [JsonPropertyName("IPDTest_HIS.Inpatient.Admission.QueryTest.exe")]
        public CurrentVersionURL IPDTest_HIS_Inpatient_Admission_QueryTest_exe { get; set; }
        [JsonPropertyName("ComplexQuery_HIS.ComplexQuery.exe")]
        public CurrentVersionURL ComplexQuery_HIS_ComplexQuery_exe { get; set; }
        [JsonPropertyName("PatientTest_HIS.Patient.Test.exe")]
        public CurrentVersionURL PatientTest_HIS_Patient_Test_exe { get; set; }
        [JsonPropertyName("DW_HIS.DW.exe")]
        public CurrentVersionURL DW_HIS_DW_exe { get; set; }
        [JsonPropertyName("NW_HIS.NW.exe")]
        public CurrentVersionURL NW_HIS_NW_exe { get; set; }
        [JsonPropertyName("OPDFree_HIS.Outpatient.RC.Free.exe")]
        public CurrentVersionURL OPDFree_HIS_Outpatient_RC_Free_exe { get; set; }
        [JsonPropertyName("SYSTEM_HIS.Foundations.exe")]
        public CurrentVersionURL SYSTEM_HIS_Foundations_exe { get; set; }
        [JsonPropertyName("IPD.SC_HIS.Inpatient.SC.exe")]
        public CurrentVersionURL IPD_SC_HIS_Inpatient_SC_exe { get; set; }
        [JsonPropertyName("Patient_HIS.Patient.exe")]
        public CurrentVersionURL Patient_HIS_Patient_exe { get; set; }
        [JsonPropertyName("AutoUpgradeComponent")]
        public CurrentVersionURL AutoUpgradeComponent { get; set; }
        [JsonPropertyName("OPDHs_HIS.Outpatient.RC.Hs.exe")]
        public CurrentVersionURL OPDHs_HIS_Outpatient_RC_Hs_exe { get; set; }
        [JsonPropertyName("DWIOInternet_HIS.DWIONET.exe")]
        public CurrentVersionURL DWIOInternet_HIS_DWIONET_exe { get; set; }
        [JsonPropertyName("IPD_HIS.Inpatient.Admission.Query.exe")]
        public CurrentVersionURL IPD_HIS_Inpatient_Admission_Query_exe { get; set; }
        [JsonPropertyName("IPD_HIS.Inpatient.Admission.Reception.exe")]
        public CurrentVersionURL IPD_HIS_Inpatient_Admission_Reception_exe { get; set; }
        [JsonPropertyName("OPDTest_HIS.Outpatient.RC.Test.exe")]
        public CurrentVersionURL OPDTest_HIS_Outpatient_RC_Test_exe { get; set; }
        [JsonPropertyName("IPDTest_HIS.Inpatient.Admission.ReceptionTest.exe")]
        public CurrentVersionURL IPDTest_HIS_Inpatient_Admission_ReceptionTest_exe { get; set; }
        #endregion

        #region CMIT

        [JsonPropertyName("HIS.NW")]
        public CurrentVersionURL HIS_NW { get; set; }
        [JsonPropertyName("HIS.DWIO")]
        public CurrentVersionURL HIS_DWIO { get; set; }
        [JsonPropertyName("HIS.Outpatient.DW")]
        public CurrentVersionURL HIS_Outpatient_DW { get; set; }
        //[JsonPropertyName("AutoUpgradeComponent")]
        //public CurrentVersionURL AutoUpgradeComponent { get; set; }
        [JsonPropertyName("HIS.Inpatient.DW")]
        public CurrentVersionURL HIS_Inpatient_DW { get; set; }

        #endregion
    }
    class AppSettings
    {
        public string UpgradePath { get; set; }
        public string UpgradeExecProgURL { get; set; }
    }

    class HISClientConfigModel
    {
        public string configFileName { get; set; }
        public HISSettingsSection settingsSection { get; set; }
        public AppSettings appSettings { get; set; }
    }

    class CMITSettingsSection
    {
        [JsonPropertyName("HIS.NW")]
        public CurrentVersionURL HIS_NW { get; set; }

        [JsonPropertyName("HIS.DWIO")]
        public CurrentVersionURL HIS_DWIO { get; set; }
        [JsonPropertyName("HIS.Outpatient.DW")]
        public CurrentVersionURL HIS_Outpatient_DW { get; set; }
        [JsonPropertyName("AutoUpgradeComponent")]
        public CurrentVersionURL AutoUpgradeComponent { get; set; }
        [JsonPropertyName("HIS.Inpatient.DW")]
        public CurrentVersionURL HIS_Inpatient_DW { get; set; }
    }
    class CMITClientConfigModel
    {
        public string configFileName { get; set; }
        public CMITSettingsSection settingsSection { get; set; }
        public AppSettings appSettings { get; set; }
    }

    HISClientConfigModel HISModal = new HISClientConfigModel() { settingsSection = new HISSettingsSection() };
    HISClientConfigModel CMITModal { get; set; }
    public async Task ConfigurationManager()
    {
        var random = new Random();
        var result = await Http.GetAsync($@"/api/ConfigurationManager");

        string resultContent = result.Content.ReadAsStringAsync().Result;
        var r = JsonSerializer.Deserialize<HISClientConfigModel[]>(resultContent);
        if (r[0].configFileName.Contains("HIS.AutoUpdate"))
        {
            HISModal = r[0];
            CMITModal = r[1];
            SYSTEM_HIS_Foundations_exe = HISModal.settingsSection.SYSTEM_HIS_Foundations_exe.currentVersionURL;
        }
        else
        {
            HISModal = r[1];
            CMITModal = r[0];
        }
    }
    protected override async Task OnInitializedAsync()
    {
        await ConfigurationManager();

    }

    string SYSTEM_HIS_Foundations_exe { get; set; }

    RenderFragment extra =@<div @onclick:stopPropagation><Icon Type="setting"></Icon></div>;

string expandIconPosition = "left";

void Callback(string[] keys)
{
Console.WriteLine(string.Join(',', keys));
}
}