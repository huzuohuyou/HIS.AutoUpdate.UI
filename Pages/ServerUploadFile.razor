@inject HttpClient Http
@using System.Text.Json;
@using HIS.AutoUpdate.Blazor.Models;
@using System;
@using System.Collections.Generic;
@using System.IO;
@using System.Runtime.Serialization.Formatters;
@inject MessageService _message
@using System.ComponentModel.DataAnnotations;
@using System.Text.Json;

<br />

<Form Model="@model"
      OnFinish="OnFinish"
      OnFinishFailed="OnFinishFailed"
      LabelColSpan="8"
      WrapperColSpan="16">
    <FormItem Label="站点">
        <Input Placeholder="configFileName" @bind-Value="@siteName" />
    </FormItem>

    
    <FormItem Label="文件">

        <Upload Action="http://192.168.5.212:20002/api/Sites/UploadFile"
                Name="files"
                @bind-FileList="fileList"
                ShowButton="fileList?.Count < 1"
                ListType="picture-card"
                Data="dict"
                OnChange="HandleChange">
            <div>
                <Icon Type="plus"></Icon>
                <div className="ant-upload-text">Upload</div>
            </div>

        </Upload>
    </FormItem>
</Form>


@code
{

    [Parameter]
    public  string siteName { get; set; } = "HSPP.BizAPI";
    Dictionary<string, object> dict = new Dictionary<string, object>()
    {
        { "siteName", "HSPP.BizAPI"}
    };

    public class CreateUpdateModel
    {
        [Required]
        public string configFileName { get; set; } = "E:\\Deployment\\HIS.AutoUpdate\\AutoUpgradeServerDefine.config";
        [Required]
        public Dictionary<string, CurrentVersionURL> settingsSection { get; set; }

    }

    public class Model
    {
        //[Required]
        //public string configFileName { get; set; } = @"E:\Deployment\HIS.AutoUpdate\AutoUpgradeServerDefine.config";
        //[Required]
        //public string settingsSection { get; set; } = @"DW_HIS.DW.exe";
        [Required]
        public string CurrentVersionURL { get; set; } = "2.0.21.2011|HIS.DW_ER_3.0.21.2011.zip";

    }
    private Model model = new Model();

    private async Task OnFinish(EditContext editContext)
    {
        try
        {

        }
        catch (Exception ex)
        {

            await _message.Error("配置失败！！！");
        }

    }

    private void OnFinishFailed(EditContext editContext)
    {
        Console.WriteLine($"Failed:{JsonSerializer.Serialize(model)}");
    }
    List<UploadFileItem> fileList = new List<UploadFileItem>
    {

    };

    async Task HandleChange(UploadInfo fileinfo)
    {
        try
        {
            if (fileinfo.File.State == UploadState.Success)
            {
                await _message.Success("文件上传成功！！！");
                fileinfo.File.Url = fileinfo.File.ObjectURL;
            }
            
        }
        catch (Exception ex)
        {

            await _message.Error(ex.Message);
        }

    }

    public class ResponseModel
    {
        public string name { get; set; }

        public string status { get; set; }

        public string url { get; set; }

        public string thumbUrl { get; set; }
    }
}

<style>
    /* you can make up upload button and sample style by using stylesheets */
    .ant-upload-select-picture-card i {
        color: #999;
        font-size: 32px;
    }

    .ant-upload-select-picture-card .ant-upload-text {
        margin-top: 8px;
        color: #666;
    }
</style>