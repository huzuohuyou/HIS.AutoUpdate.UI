@inject HttpClient Http
@using System.Text.Json;
@using HIS.AutoUpdate.Blazor.Models;
@using System;
@using System.Collections.Generic;
@using System.IO;
@using System.Runtime.Serialization.Formatters;
@inject MessageService _message
@using System.ComponentModel.DataAnnotations;
@using System.Text.Json;
@using Microsoft.Extensions.Options;
@inject IJSRuntime JSRuntime;
@inject IOptionsSnapshot<MyProSettings> MyProSettings;

<Form Model="@model"
      OnFinish="OnFinish"
      OnFinishFailed="OnFinishFailed"
      LabelColSpan="8"
      WrapperColSpan="16">
    <FormItem Label="配置文件">
        <Input Placeholder="configFileName" @bind-Value="@configFileName" />
    </FormItem>

    <FormItem Label="模块">
        <Input Placeholder="settingsSection" @bind-Value="@settingsSection" />
    </FormItem>
    <FormItem Label="版本">

        <Input Placeholder="CurrentVersionURL" @bind-Value="@context.CurrentVersionURL" />
    </FormItem>
    <FormItem Label="文件">

        <Upload Action=@MyProSettings.Value.ClientUploadUri
                Name="files"
                @bind-FileList="fileList"
                ShowButton="fileList?.Count < 1"
                ListType="picture-card"
                Data="dict"
                OnChange="HandleChange">
            <div>
                <Icon Type="plus"></Icon>
                <div className="ant-upload-text">Upload</div>
            </div>

        </Upload>
    </FormItem>

    <FormItem WrapperColOffset="8" WrapperColSpan="16">
        <Button Type="@ButtonType.Primary" HtmlType="submit">
            提交
        </Button>
    </FormItem>
</Form>


@code
{
    [Parameter]
    public string settingsSection { get; set; } = @"DW_HIS.DW.exe";
    [Parameter]
    public string configFileName { get; set; } = "E:\\Deployment\\HIS.AutoUpdate\\AutoUpgradeServerDefine.config";
    Dictionary<string, object> dict = new Dictionary<string, object>()
{
        { "configFileName",@"E:\Deployment\HIS.AutoUpdate\AutoUpgradeServerDefine.config"}
    };

    public class CreateUpdateModel
    {
        [Required]
        public string configFileName { get; set; } = "E:\\Deployment\\HIS.AutoUpdate\\AutoUpgradeServerDefine.config";
        [Required]
        public Dictionary<string, CurrentVersionURL> settingsSection { get; set; }

    }

    protected override void OnInitialized()
    {
        dict["configFileName"] = configFileName;
        base.OnInitialized();
    }

    public class Model
    {
        //[Required]
        //public string configFileName { get; set; } = @"E:\Deployment\HIS.AutoUpdate\AutoUpgradeServerDefine.config";
        //[Required]
        //public string settingsSection { get; set; } = @"DW_HIS.DW.exe";
        [Required]
        public string CurrentVersionURL { get; set; } = "2.0.21.2011|HIS.DW_ER_3.0.21.2011.zip";

    }
    private Model model = new Model();

    private async Task OnFinish(EditContext editContext)
    {
        try
        {
            var createUpdateModel = new CreateUpdateModel()
            {
                configFileName = configFileName,
                settingsSection = new Dictionary<string, CurrentVersionURL>()
            {
                    { settingsSection, new CurrentVersionURL() { currentVersionURL = model.CurrentVersionURL } }
                }
            };
            var result = await Http.PostAsJsonAsync<CreateUpdateModel>($@"/api/ConfigurationManager", createUpdateModel);

            string resultContent = result.Content.ReadAsStringAsync().Result;
        }
        catch (Exception ex)
        {

            await _message.Error("配置失败！！！");
        }

    }

    private void OnFinishFailed(EditContext editContext)
    {
        Console.WriteLine($"Failed:{JsonSerializer.Serialize(model)}");
    }
    List<UploadFileItem> fileList = new List<UploadFileItem> { };

    async Task HandleChange(UploadInfo fileinfo)
    {
        try
        {
            if (fileinfo.File.State == UploadState.Success)
            {
                await _message.Success("文件上传成功！！！");
                fileinfo.File.Url = fileinfo.File.ObjectURL;
            }
            else if (fileinfo.File.State == UploadState.Fail)
            {
                await _message.Error($@"上传失败！！！{fileinfo.File.FileName}");
            }
        }
        catch (Exception ex)
        {

            await _message.Error(ex.Message);
        }

    }


}

<style>
    /* you can make up upload button and sample style by using stylesheets */
    .ant-upload-select-picture-card i {
        color: #999;
        font-size: 32px;
    }

    .ant-upload-select-picture-card .ant-upload-text {
        margin-top: 8px;
        color: #666;
    }
</style>